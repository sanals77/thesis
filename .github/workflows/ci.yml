name: CI - Build and Test with Policy Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 537651148488
  ECR_API_REPOSITORY: cloud-native-app-dev-api-service
  ECR_WORKER_REPOSITORY: cloud-native-app-dev-worker-service

jobs:
  # Linting and Unit Tests
  lint-and-test:
    name: Lint and Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies for API service
        run: |
          cd microservices/api-service
          pip install -r requirements.txt
          pip install pytest pytest-cov flake8

      - name: Lint API service
        run: |
          cd microservices/api-service
          flake8 app.py --max-line-length=120 --ignore=E402

      - name: Run API service tests
        run: |
          cd microservices/api-service
          pytest test_app.py -v --cov=app --cov-report=xml

      - name: Install dependencies for Worker service
        run: |
          cd microservices/worker-service
          pip install -r requirements.txt
          pip install pytest pytest-cov flake8

      - name: Lint Worker service
        run: |
          cd microservices/worker-service
          flake8 worker.py --max-line-length=120

      - name: Run Worker service tests
        run: |
          cd microservices/worker-service
          pytest test_worker.py -v --cov=worker --cov-report=xml

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./microservices/api-service/coverage.xml,./microservices/worker-service/coverage.xml

  # Build Docker images
  build-images:
    name: Build and Scan Docker Images
    runs-on: ubuntu-latest
    needs: lint-and-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API service image
        uses: docker/build-push-action@v5
        with:
          context: ./microservices/api-service
          file: ./microservices/api-service/Dockerfile
          tags: ${{ env.ECR_API_REPOSITORY }}:${{ github.sha }}
          outputs: type=docker,dest=/tmp/api-image.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Worker service image
        uses: docker/build-push-action@v5
        with:
          context: ./microservices/worker-service
          file: ./microservices/worker-service/Dockerfile
          tags: ${{ env.ECR_WORKER_REPOSITORY }}:${{ github.sha }}
          outputs: type=docker,dest=/tmp/worker-image.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Load images
        run: |
          docker load --input /tmp/api-image.tar
          docker load --input /tmp/worker-image.tar

      - name: Install Trivy
        run: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy

      - name: Scan API image with Trivy
        run: |
          trivy image --severity HIGH,CRITICAL --format json --output api-scan-results.json ${{ env.ECR_API_REPOSITORY }}:${{ github.sha }}
          trivy image --severity HIGH,CRITICAL ${{ env.ECR_API_REPOSITORY }}:${{ github.sha }}

      - name: Scan Worker image with Trivy
        run: |
          trivy image --severity HIGH,CRITICAL --format json --output worker-scan-results.json ${{ env.ECR_WORKER_REPOSITORY }}:${{ github.sha }}
          trivy image --severity HIGH,CRITICAL ${{ env.ECR_WORKER_REPOSITORY }}:${{ github.sha }}

      - name: Upload scan results
        uses: actions/upload-artifact@v3
        with:
          name: trivy-scan-results
          path: |
            api-scan-results.json
            worker-scan-results.json

      - name: Check for vulnerabilities
        run: |
          if [ $(cat api-scan-results.json | jq '.Results[].Vulnerabilities | length') -gt 0 ]; then
            echo "Critical vulnerabilities found in API image!"
            exit 1
          fi
          if [ $(cat worker-scan-results.json | jq '.Results[].Vulnerabilities | length') -gt 0 ]; then
            echo "Critical vulnerabilities found in Worker image!"
            exit 1
          fi

      - name: Upload images as artifacts
        uses: actions/upload-artifact@v3
        with:
          name: docker-images
          path: |
            /tmp/api-image.tar
            /tmp/worker-image.tar

  # Validate Terraform with OPA
  validate-terraform:
    name: Validate Terraform with Policy-as-Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa
          sudo mv opa /usr/local/bin/

      - name: Terraform Init
        run: |
          cd infrastructure/terraform
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd infrastructure/terraform
          terraform validate

      - name: Terraform Plan
        run: |
          cd infrastructure/terraform
          terraform plan -out=tfplan.binary
          terraform show -json tfplan.binary > tfplan.json

      - name: Validate Terraform Plan with OPA - Security
        run: |
          cd infrastructure/terraform
          opa eval --data ../../policies/terraform/security.rego --input tfplan.json --format pretty "data.terraform.security.deny"

      - name: Validate Terraform Plan with OPA - Cost
        run: |
          cd infrastructure/terraform
          opa eval --data ../../policies/terraform/cost.rego --input tfplan.json --format pretty "data.terraform.cost.warn"

      - name: Upload Terraform plan
        uses: actions/upload-artifact@v3
        with:
          name: terraform-plan
          path: infrastructure/terraform/tfplan.json

  # Validate Kubernetes manifests with OPA
  validate-kubernetes:
    name: Validate Kubernetes Manifests with Policy-as-Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'

      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa
          sudo mv opa /usr/local/bin/

      - name: Render Helm templates - API Service
        run: |
          helm template api-service ./infrastructure/kubernetes/helm/api-service > api-manifests.yaml

      - name: Render Helm templates - Worker Service
        run: |
          helm template worker-service ./infrastructure/kubernetes/helm/worker-service > worker-manifests.yaml

      - name: Validate API manifests with OPA
        run: |
          while IFS= read -r line; do
            if [[ "$line" == "---" ]] || [[ -z "$line" ]]; then
              if [[ -n "$manifest" ]]; then
                echo "$manifest" | opa eval --data policies/kubernetes/security.rego --input - --format pretty "data.kubernetes.security" || true
              fi
              manifest=""
            else
              manifest="$manifest$line"$'\n'
            fi
          done < api-manifests.yaml

      - name: Validate Worker manifests with OPA
        run: |
          while IFS= read -r line; do
            if [[ "$line" == "---" ]] || [[ -z "$line" ]]; then
              if [[ -n "$manifest" ]]; then
                echo "$manifest" | opa eval --data policies/kubernetes/security.rego --input - --format pretty "data.kubernetes.security" || true
              fi
              manifest=""
            else
              manifest="$manifest$line"$'\n'
            fi
          done < worker-manifests.yaml

  # Generate SBOM
  generate-sbom:
    name: Generate Software Bill of Materials
    runs-on: ubuntu-latest
    needs: build-images
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download images
        uses: actions/download-artifact@v3
        with:
          name: docker-images
          path: /tmp

      - name: Load images
        run: |
          docker load --input /tmp/api-image.tar
          docker load --input /tmp/worker-image.tar

      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Generate SBOM for API service
        run: |
          syft ${{ env.ECR_API_REPOSITORY }}:${{ github.sha }} -o cyclonedx-json > api-sbom.json

      - name: Generate SBOM for Worker service
        run: |
          syft ${{ env.ECR_WORKER_REPOSITORY }}:${{ github.sha }} -o cyclonedx-json > worker-sbom.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v3
        with:
          name: sbom
          path: |
            api-sbom.json
            worker-sbom.json
